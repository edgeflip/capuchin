{% macro multibar(id, columns, title, data, date_format="%m/%d/%y %H:%M:00") %}
    <div class="col-md-{{columns}} dash-chart">
        <h3>{{title}}</h3>
        <div id="chart{{id}}">
            <svg></svg>
        </div>
    </div>
    <script>
        $(document).ready(build_multibarchart_{{id}});

        function build_multibarchart_{{id}}(){
            var data = eval({{data|safe}});
            nv.addGraph(function() {
                var chart = nv.models.multiBarChart();

                chart.xAxis
                .tickFormat(function(d) {
                    return d3.time.format("{{date_format}}")(new Date(d));
                });

                chart.yAxis
                .tickFormat(d3.format(',.1f'));
                d3.select('#chart{{id}} svg')
                .datum(data)
                .transition().duration(500)
                .call(chart)
                ;

                nv.utils.windowResize(chart.update);

                return chart;
            });
        }
    </script>
{% endmacro %}


{% macro pie(id, columns, title, data) %}
    <div class="col-md-{{columns}} dash-chart pie">
        <h3>{{title}}</h3>
        <div id="chart{{id}}">
            <svg></svg>
        </div>
    </div>
    <script>
    $(document).ready(build_piechart_{{id}});

    function build_piechart_{{id}}(){
        var data = eval({{data|safe}});
        nv.addGraph(function() {
            var chart = nv.models.pieChart()
            .x(function(d) { return d.label })
            .y(function(d) { return d.value })
            .showLabels(true)     //Display pie labels
            .labelThreshold(.05)  //Configure the minimum slice size for labels to show up
            .labelType("percent") //Configure what type of data to show in the label. Can be "key", "value" or "percent"
            .donut(true)          //Turn on Donut mode. Makes pie chart look tasty!
            .donutRatio(0.35)     //Configure how big you want the donut hole size to be.
            ;

            d3.select("#chart{{id}} svg")
            .datum(data)
            .transition().duration(350)
            .call(chart);

            return chart;
        });
    }
    </script>
{% endmacro %}

{% macro stackedline(id, columns, title, data, date_format) %}
    <div class="col-md-{{columns}} dash-chart stackedline">
        <h3>{{title}}</h3>
        <div id="chart{{id}}">
            <svg></svg>
        </div>
    </div>
    <script>
    $(document).ready(build_stackedline_{{id}});

    function build_stackedline_{{id}}(){
        var data = eval({{data|safe}});
        console.log(data);
        nv.addGraph(function() {
            var chart = nv.models.stackedAreaChart()
            .x(function(d) { return d.x })   //We can modify the data accessor functions...
            .y(function(d) { return d.y })   //...in case your data is formatted differently.
            .useInteractiveGuideline(true)    //Tooltips which show all data points. Very nice!
            .transitionDuration(500);

            //Format x-axis labels with custom function.
            chart.xAxis
            .tickFormat(function(d) {
                return d3.time.format("{{date_format}}")(new Date(d))
            });

            chart.yAxis
            .tickFormat(d3.format(',.2f'));

            d3.select('#chart{{id}} svg')
            .datum(data)
            .call(chart);

            nv.utils.windowResize(chart.update);
        });
    };
    </script>
{% endmacro %}


{% macro lineplusbar(id, columns, title, data, date_format) %}
<div class="col-md-{{columns}} dash-chart stackedline">
    <h3>{{title}}</h3>
    <div id="chart{{id}}">
        <svg></svg>
    </div>
</div>
<script>
$(document).ready(build_stackedline_{{id}});

function build_stackedline_{{id}}(){
    var data = eval({{data|safe}});
    console.log(data);
    nv.addGraph(function() {
        var chart = nv.models.linePlusBarChart()
        .x(function(d) { return d.x })   //We can modify the data accessor functions...
        .y(function(d) { return d.y })   //...in case your data is formatted differently.

        //Format x-axis labels with custom function.
        chart.xAxis
        .tickFormat(function(d) {
            return d3.time.format("{{date_format}}")(new Date(d))
        });

        chart.y1Axis
        .tickFormat(d3.format(',.2f'));

        chart.y2Axis
        .tickFormat(d3.format(',.2f'));

        chart.bars.forceY([0]);

        d3.select('#chart{{id}} svg')
        .datum(data)
        .call(chart);

        nv.utils.windowResize(chart.update);
    });
};
</script>
{% endmacro %}

{% macro usa(id, columns, title, data) %}
<div class="col-md-{{columns}} dash-chart usa">
    <h3>{{title}}</h3>
    <div id="chart{{id}}" class="geo"></div>
</div>
<script>
$(document).ready(build_usa_{{id}});

function build_usa_{{id}}(){
    var data = eval({{data|safe}});
    var width = "100%",
    height = "100%";

    var projection = d3.geo.albersUsa()
    .scale(800)
    .translate([$("#chart{{id}}").width() / 2, $("#chart{{id}}").height() / 2]);

    var path = d3.geo.path()
    .projection(projection);

    var svg = d3.select("#chart{{id}}").append("svg")
    .attr("width", width)
    .attr("height", height);

    var radius = d3.scale.sqrt()
    .domain([0, 300])
    .range([0, 15]);

    d3.json("/static/json/us.json", function(error, us) {
        svg.insert("path", ".graticule")
        .datum(topojson.feature(us, us.objects.land))
        .attr("class", "land")
        .attr("d", path);

        svg.insert("path", ".graticule")
        .datum(topojson.mesh(us, us.objects.counties, function(a, b) { return a !== b && !(a.id / 1000 ^ b.id / 1000); }))
        .attr("class", "county-boundary")
        .attr("d", path);

        svg.insert("path", ".graticule")
        .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
        .attr("class", "state-boundary")
        .attr("d", path);

        data.forEach(function(d) {
            var p = projection([+d.lng, +d.lat]);
            if (p){
                d.x = Math.round(p[0]);
                d.y = Math.round(p[1]);
                var c = svg.append("circle")
                .attr("cx", d.x)
                .attr("cy", d.y)
                .attr("class", "bubble")
                .attr("r", function() { console.log(d); return radius(d.count); });

                c.append("title").text(function(){
                    return d.name+": "+d.count;
                })
            }
        });
    });
};
</script>
{% endmacro %}
